name: Cataclysm Windows build (CMake + MSVC)

on:
  push:
    branches:
      - main
    paths-ignore:
      - "android/**"
      - "build-data/osx/**"
      - "docs/**"
      - "doxygen_doc/**"
      - "gfx/**"
      - "lang/**"
      - "lgtm/**"
      - "tools/**"
      - "!tools/format/**"
      - "utilities/**"
      - "scripts/**"
      - "**.md"
      - "**.mdx"
  pull_request:
    branches:
      - main
    paths-ignore:
      - "android/**"
      - "build-data/osx/**"
      - "docs/**"
      - "doxygen_doc/**"
      - "gfx/**"
      - "lang/**"
      - "lgtm/**"
      - "tools/**"
      - "!tools/format/**"
      - "utilities/**"
      - "scripts/**"
      - "**.md"
      - "**.mdx"
# We only care about the latest revision, so cancel previous instances.
concurrency:
  group: msvc-cmake-build-${{ github.ref_name }}
  cancel-in-progress: true

env:
  VCPKG_BINARY_SOURCES: "clear;x-gha,readwrite"
  # There's not enough disk space to build both release and debug versions of
  # our dependencies, so we hack the triplet file to build only release versions
  # Have to use github.workspace because runner namespace isn't available yet.
  VCPKG_OVERLAY_TRIPLETS: ${{ github.workspace }}\.github\vcpkg_triplets
  ZSTD_CLEVEL: 17
  CMAKE_PRESET: windows-tiles-sounds-x64-msvc
  BUILD_CONFIG: ${{ github.event_name == 'pull_request' && 'Debug' || 'RelWithDebInfo' }}

jobs:
  build_catatclysm:
    name: Build
    runs-on: windows-latest
    if: github.event.pull_request.draft == false

    steps:
      - name: checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Add msbuild to PATH
        uses: microsoft/setup-msbuild@v2
        with:
          vs-version: 17.13

      - name: Remove Strawberry Perl from PATH
        run: |
          echo $env:PATH
          echo =========================
          $env:PATH = $env:PATH -replace "C:\\Strawberry\\c\\bin;", ""
          $env:PATH = $env:PATH -replace "C:\\Strawberry\\perl\\site\\bin;", ""
          $env:PATH = $env:PATH -replace "C:\\Strawberry\\perl\\bin;", ""
          "PATH=$env:PATH" | Out-File -FilePath $env:GITHUB_ENV -Append
          echo =========================
          echo $env:PATH

      - name: Install stable CMake
        uses: lukka/get-cmake@v3.31.6

      # https://learn.microsoft.com/en-us/vcpkg/consume/binary-caching-github-actions-cache#1---export-required-github-actions-environment-variables
      - name: Export GitHub Actions cache environment variables
        uses: actions/github-script@v7
        with:
          script: |
            core.exportVariable("ACTIONS_CACHE_URL", process.env.ACTIONS_CACHE_URL || "")
            core.exportVariable("ACTIONS_RUNTIME_TOKEN", process.env.ACTIONS_RUNTIME_TOKEN || "")

      - name: Install vcpkg
        uses: lukka/run-vcpkg@main
        id: runvcpkg
        with:
          vcpkgDirectory: "${{ runner.workspace }}/b/vcpkg"

      - name: Integrate vcpkg
        run: |
          vcpkg integrate install

      - name: Export GitHub Actions cache environment variables
        uses: actions/github-script@v7
        with:
          script: |
            core.exportVariable("ACTIONS_CACHE_URL", process.env.ACTIONS_CACHE_URL || "")
            core.exportVariable("ACTIONS_RUNTIME_TOKEN", process.env.ACTIONS_RUNTIME_TOKEN || "")

      - name: Setup ccache
        uses: hendrikmuhs/ccache-action@v1.2
        with:
          key: msvc-cmake-${{ env.CMAKE_PRESET }}-${{ github.ref_name }}
          restore-keys: |
            msvc-cmake-${{ env.CMAKE_PRESET }}-${{ github.ref_name }}
            msvc-cmake-${{ env.CMAKE_PRESET }}-main
            msvc-cmake-${{ env.CMAKE_PRESET }}-
          max-size: 500M
          verbose: 2
          save: ${{ github.event_name != 'pull_request' }}

      - name: Configure ccache for MSVC
        run: |
          echo "CCACHE_BASEDIR=${{ github.workspace }}" >> $env:GITHUB_ENV
          echo "CCACHE_SLOPPINESS=include_file_ctime,include_file_mtime,time_macros,pch_defines" >> $env:GITHUB_ENV
          echo "CCACHE_NOHASHDIR=1" >> $env:GITHUB_ENV

      - name: Configure and Build (PR Debug)
        if: ${{ github.event_name == 'pull_request' }}
        uses: lukka/run-cmake@v10
        with:
          configurePreset: ${{ env.CMAKE_PRESET }}
          buildPreset: windows-msvc-build
          configurePresetAdditionalArgs: "['-DJSON_FORMAT=OFF']"
          buildPresetAdditionalArgs: "['--config', '${{ env.BUILD_CONFIG }}', '--target', 'cataclysm-bn-tiles', '--target', 'cata_test-tiles', '--target', 'translations']"

      - name: Configure and Build
        if: ${{ github.event_name != 'pull_request' }}
        uses: lukka/run-cmake@v10
        with:
          configurePreset: ${{ env.CMAKE_PRESET }}
          buildPreset: windows-msvc-build
          buildPresetAdditionalArgs: "['--config', '${{ env.BUILD_CONFIG }}']"

      - name: Dump logs if build failed
        if: failure()
        run: |
          echo =================================================
          Get-ChildItem "${{ runner.workspace }}/Cataclysm-BN/out/build/$env:CMAKE_PRESET" -Recurse
          echo =================================================

      - name: Compile .mo files for localization
        run: |
          cmake --build out/build/$env:CMAKE_PRESET --target translations_compile --config $env:BUILD_CONFIG

      - name: ccache stats
        run: |
          ccache -s -vv

      - name: Run tests
        run: |
          & "out/build/$env:CMAKE_PRESET/tests/$env:BUILD_CONFIG/cata_test-tiles.exe" --rng-seed time

      - name: Create PR debug distribution zip
        if: ${{ github.event_name == 'pull_request' && success() }}
        shell: pwsh
        run: |
          $suffix = "pr-${{ github.event.pull_request.number }}-$($env:GITHUB_SHA.Substring(0,7))"
          $distDir = "cataclysmbn-$suffix"

          cmake --install "out/build/$env:CMAKE_PRESET" --prefix "$distDir" --config $env:BUILD_CONFIG
          Compress-Archive -Force -Path "$distDir/*" -DestinationPath "cbn-windows-tiles-debug-$suffix.zip"

      - name: Upload PR debug distribution zip
        if: ${{ github.event_name == 'pull_request' && success() }}
        uses: actions/upload-artifact@v4.6.0
        with:
          name: cbn-windows-tiles-debug-pr-${{ github.event.pull_request.number }}
          path: cbn-windows-tiles-debug-*.zip
          if-no-files-found: error
          retention-days: 14
